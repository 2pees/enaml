

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>enaml.core.enaml_compiler &mdash; enaml 0.7.6 documentation</title>
    
    <link rel="stylesheet" href="../../../_static/rtd.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '0.7.6',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="top" title="enaml 0.7.6 documentation" href="../../../index.html" />
    <link rel="up" title="Module code" href="../../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">enaml v0.7.6</a> &raquo;</li>
          <li><a href="../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for enaml.core.enaml_compiler</h1><div class="highlight"><pre>
<span class="c">#------------------------------------------------------------------------------</span>
<span class="c"># Copyright (c) 2013, Nucleic Development Team.</span>
<span class="c">#</span>
<span class="c"># Distributed under the terms of the Modified BSD License.</span>
<span class="c">#</span>
<span class="c"># The full license is in the file COPYING.txt, distributed with this software.</span>
<span class="c">#------------------------------------------------------------------------------</span>
<span class="kn">import</span> <span class="nn">ast</span>
<span class="kn">import</span> <span class="nn">types</span>

<span class="kn">from</span> <span class="nn">.byteplay</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Code</span><span class="p">,</span> <span class="n">LOAD_FAST</span><span class="p">,</span> <span class="n">CALL_FUNCTION</span><span class="p">,</span> <span class="n">LOAD_GLOBAL</span><span class="p">,</span> <span class="n">STORE_FAST</span><span class="p">,</span> <span class="n">LOAD_CONST</span><span class="p">,</span>
    <span class="n">RETURN_VALUE</span><span class="p">,</span> <span class="n">STORE_NAME</span><span class="p">,</span> <span class="n">LOAD_NAME</span><span class="p">,</span> <span class="n">DELETE_NAME</span><span class="p">,</span> <span class="n">DELETE_FAST</span><span class="p">,</span> <span class="n">SetLineno</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">.code_tracing</span> <span class="kn">import</span> <span class="n">inject_tracing</span><span class="p">,</span> <span class="n">inject_inversion</span>


<span class="c"># Increment this number whenever the compiler changes the code which it</span>
<span class="c"># generates. This number is used by the import hooks to know which version</span>
<span class="c"># of a .enamlc file is valid for the Enaml compiler version in use. If</span>
<span class="c"># this number is not incremented on change, it may result in .enamlc</span>
<span class="c"># files which fail on import.</span>
<span class="c">#</span>
<span class="c"># Version History</span>
<span class="c"># ---------------</span>
<span class="c"># 1 : Initial compiler version - 2 February 2012</span>
<span class="c"># 2 : Update line number handling - 26 March 2012</span>
<span class="c">#     When compiling code objects with mode=&#39;eval&#39;, Python ignores the</span>
<span class="c">#     line number specified by the ast. The workaround is to compile the</span>
<span class="c">#     code object, then make a new copy of it with the proper firstlineno</span>
<span class="c">#     set via the types.CodeType constructor.</span>
<span class="c"># 3 : Update the generated code to remove the toolkit - 21 June 2012</span>
<span class="c">#     This updates the compiler for the coming switch to async UI&#39;s</span>
<span class="c">#     which will see the removal of the Toolkit concept. The only</span>
<span class="c">#     magic scope maintained is for that of operators.</span>
<span class="c"># 4 : Update component building - 27 July 2012</span>
<span class="c">#     This updates the compiler to handle the new Enaml creation semantics</span>
<span class="c">#     that don&#39;t rely on __enaml_call__. Instead the parent is passed</span>
<span class="c">#     directly to the component cls which is a subclass of Declarative.</span>
<span class="c">#     That class handles calling the builder functions upon instance</span>
<span class="c">#     creation. This allows us to get rid of the EnamlDef class and</span>
<span class="c">#     make enamldef constructs proper subclasses of Declarative.</span>
<span class="c"># 5 : Change the import names - 28 July 2012</span>
<span class="c">#     This changes the imported helper name from _make_decl_subclass_</span>
<span class="c">#     to _make_enamldef_helper_ which is more descriptive, but equally</span>
<span class="c">#     mangled. It also updates the method name used on the Declarative</span>
<span class="c">#     component for adding attribute from _add_decl_attr to the more</span>
<span class="c">#     descriptive _add_user_attribute. Finally, it adds the eval_compile</span>
<span class="c">#     function for compiling Python code in &#39;eval&#39; mode with proper line</span>
<span class="c">#     number handling.</span>
<span class="c"># 6 : Compile with code tracing - 24 November 2012</span>
<span class="c">#     This updates the compiler to generate code using the idea of code</span>
<span class="c">#     tracing instead of monitors and inverters. The compiler compiles</span>
<span class="c">#     the expressions into functions which are augmented to accept</span>
<span class="c">#     additional arguments. These arguments are tracer objects which will</span>
<span class="c">#     have methods called in response to bytecode ops executing. These</span>
<span class="c">#     methods can then attach listeners as necessary. This is an easier</span>
<span class="c">#     paradigm to develop with than the previous incarnation. This new</span>
<span class="c">#     way also allows the compiler to generate the final code objects</span>
<span class="c">#     upfront, instead of needed to specialize at runtime for a given</span>
<span class="c">#     operator context. This results in a much smaller footprint since</span>
<span class="c">#     then number of code objects created is n instead of n x m.</span>
<span class="c"># 7 : Fix bug with local deletes - 10 December 2012</span>
<span class="c">#     This fixes a bug in the locals optimization where the DELETE_NAME</span>
<span class="c">#     opcode was not being replaced with DELETE_FAST.</span>
<span class="c"># 8 : Generate description dicts instead of builders - 27 January 2013</span>
<span class="c">#     This updates the compiler to generate marshalable description</span>
<span class="c">#     dicts instead of builder functions. The responsibility of building</span>
<span class="c">#     out the object tree has been shifted to the Declarative class. This</span>
<span class="c">#     is a touch slower, but provides a ton more flexibility and enables</span>
<span class="c">#     templated components like `Looper` and `Conditional`.</span>
<span class="c"># 9 : Generate description dicts for attrs and events - 11 March 2013</span>
<span class="c">#     This augments the description dictionary for an enamldef with</span>
<span class="c">#     a list of dicts describing the &#39;attr&#39; and &#39;event&#39; keywords for</span>
<span class="c">#     the given enamldef block. These dicts are used by the compiler</span>
<span class="c">#     helper to generate atom members for the new class.</span>
<span class="c"># 10 : Class time post processing and decorators - 17 March 2013</span>
<span class="c">#     This moves a large amount of processing from instantiation time</span>
<span class="c">#     to class definition time. In particular, operators are now bound</span>
<span class="c">#     at the class level. This also adds support for decorators on an</span>
<span class="c">#     enamldef block.</span>
<span class="c"># 11 : Fix a bug in code generation for Python 2.6 - 18 March 2013</span>
<span class="c">#     On Python 2.6 the LIST_APPEND instruction consumes the TOS. This</span>
<span class="c">#     update adds a check for running on &lt; 2.7 and dups the TOS.</span>
<span class="c"># 12 : Post process an enamldef immediately. - 18 March 2013</span>
<span class="c">#     This removes the need for the 2.6 check from version 11 since it</span>
<span class="c">#     does not rely on the LIST_APPEND instruction. It almost means</span>
<span class="c">#     that widget names must appear before they are used, just like in</span>
<span class="c">#     normal Python class bodies.</span>
<span class="c"># 13 : Move the post processing of enamldefs to before running the</span>
<span class="c">#     decorators. This means a decorator gets a complete class.</span>
<span class="c"># 14 : Updates to the parser and ast to be more structured - 22 March 2013</span>
<span class="c">#     This updates ast generated by the parser and updates the process</span>
<span class="c">#     for class creation when a module is imported. The serialized data</span>
<span class="c">#     which lives in the code object is unpacked into a construction</span>
<span class="c">#     tree which is then used for various transformations.</span>
<span class="n">COMPILER_VERSION</span> <span class="o">=</span> <span class="mi">14</span>


<span class="c">#------------------------------------------------------------------------------</span>
<span class="c"># Compiler Helpers</span>
<span class="c">#------------------------------------------------------------------------------</span>
<span class="c"># Code that will be executed at the top of every enaml module</span>
<span class="n">STARTUP</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;from enaml.core.compiler_helpers import __make_enamldef_helper&#39;</span><span class="p">]</span>


<span class="c"># Cleanup code that will be included in every compiled enaml module</span>
<span class="n">CLEANUP</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;del __make_enamldef_helper&#39;</span><span class="p">]</span>


<div class="viewcode-block" id="update_firstlineno"><a class="viewcode-back" href="../../../api_ref/enaml.core.html#enaml.core.enaml_compiler.update_firstlineno">[docs]</a><span class="k">def</span> <span class="nf">update_firstlineno</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">firstlineno</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Returns a new code object with an updated first line number.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">types</span><span class="o">.</span><span class="n">CodeType</span><span class="p">(</span>
        <span class="n">code</span><span class="o">.</span><span class="n">co_argcount</span><span class="p">,</span> <span class="n">code</span><span class="o">.</span><span class="n">co_nlocals</span><span class="p">,</span> <span class="n">code</span><span class="o">.</span><span class="n">co_stacksize</span><span class="p">,</span> <span class="n">code</span><span class="o">.</span><span class="n">co_flags</span><span class="p">,</span>
        <span class="n">code</span><span class="o">.</span><span class="n">co_code</span><span class="p">,</span> <span class="n">code</span><span class="o">.</span><span class="n">co_consts</span><span class="p">,</span> <span class="n">code</span><span class="o">.</span><span class="n">co_names</span><span class="p">,</span> <span class="n">code</span><span class="o">.</span><span class="n">co_varnames</span><span class="p">,</span>
        <span class="n">code</span><span class="o">.</span><span class="n">co_filename</span><span class="p">,</span> <span class="n">code</span><span class="o">.</span><span class="n">co_name</span><span class="p">,</span> <span class="n">firstlineno</span><span class="p">,</span> <span class="n">code</span><span class="o">.</span><span class="n">co_lnotab</span><span class="p">,</span>
        <span class="n">code</span><span class="o">.</span><span class="n">co_freevars</span><span class="p">,</span> <span class="n">code</span><span class="o">.</span><span class="n">co_cellvars</span><span class="p">,</span>
    <span class="p">)</span>


<span class="c">#------------------------------------------------------------------------------</span>
<span class="c"># Expression Compilers</span>
<span class="c">#------------------------------------------------------------------------------</span></div>
<div class="viewcode-block" id="replace_global_loads"><a class="viewcode-back" href="../../../api_ref/enaml.core.html#enaml.core.enaml_compiler.replace_global_loads">[docs]</a><span class="k">def</span> <span class="nf">replace_global_loads</span><span class="p">(</span><span class="n">codelist</span><span class="p">,</span> <span class="n">explicit</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; A code transformer which rewrites LOAD_GLOBAL opcodes.</span>

<span class="sd">    This transform will replace the LOAD_GLOBAL opcodes with LOAD_NAME</span>
<span class="sd">    opcodes. The operation is performed in-place.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    codelist : list</span>
<span class="sd">        The list of byteplay code ops to modify.</span>

<span class="sd">    explicit : set or None</span>
<span class="sd">        The set of global names declared explicitly and which should</span>
<span class="sd">        remain untransformed.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># Replacing LOAD_GLOBAL with LOAD_NAME enables dynamic scoping by</span>
    <span class="c"># way of a custom locals mapping. The `call_func` function in the</span>
    <span class="c"># `funchelper` module enables passing a locals map to a function.</span>
    <span class="n">explicit</span> <span class="o">=</span> <span class="n">explicit</span> <span class="ow">or</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">op_arg</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">codelist</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">op</span> <span class="o">==</span> <span class="n">LOAD_GLOBAL</span> <span class="ow">and</span> <span class="n">op_arg</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">explicit</span><span class="p">:</span>
            <span class="n">codelist</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">LOAD_NAME</span><span class="p">,</span> <span class="n">op_arg</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="optimize_locals"><a class="viewcode-back" href="../../../api_ref/enaml.core.html#enaml.core.enaml_compiler.optimize_locals">[docs]</a><span class="k">def</span> <span class="nf">optimize_locals</span><span class="p">(</span><span class="n">codelist</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Optimize the given code object for fast locals access.</span>

<span class="sd">    All STORE_NAME opcodes will be replaced with STORE_FAST. Names which</span>
<span class="sd">    are stored and then loaded via LOAD_NAME are rewritten to LOAD_FAST</span>
<span class="sd">    and DELETE_NAME is rewritten to DELETE_FAST. This transformation is</span>
<span class="sd">    applied in-place.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    codelist : list</span>
<span class="sd">        The list of byteplay code ops to modify.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fast_locals</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">op_arg</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">codelist</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">op</span> <span class="o">==</span> <span class="n">STORE_NAME</span><span class="p">:</span>
            <span class="n">fast_locals</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">op_arg</span><span class="p">)</span>
            <span class="n">codelist</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">STORE_FAST</span><span class="p">,</span> <span class="n">op_arg</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">op_arg</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">codelist</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">op</span> <span class="o">==</span> <span class="n">LOAD_NAME</span> <span class="ow">and</span> <span class="n">op_arg</span> <span class="ow">in</span> <span class="n">fast_locals</span><span class="p">:</span>
            <span class="n">codelist</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">LOAD_FAST</span><span class="p">,</span> <span class="n">op_arg</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="n">DELETE_NAME</span> <span class="ow">and</span> <span class="n">op_arg</span> <span class="ow">in</span> <span class="n">fast_locals</span><span class="p">:</span>
            <span class="n">codelist</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">DELETE_FAST</span><span class="p">,</span> <span class="n">op_arg</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="compile_simple"><a class="viewcode-back" href="../../../api_ref/enaml.core.html#enaml.core.enaml_compiler.compile_simple">[docs]</a><span class="k">def</span> <span class="nf">compile_simple</span><span class="p">(</span><span class="n">py_ast</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Compile an ast into a code object implementing operator `=`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    py_ast : ast.Expression</span>
<span class="sd">        A Python ast Expression node.</span>

<span class="sd">    filename : string</span>
<span class="sd">        The filename which generated the expression.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    result : types.CodeType</span>
<span class="sd">        A Python code object which implements the desired behavior.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">code</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="n">py_ast</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&#39;eval&#39;</span><span class="p">)</span>
    <span class="n">code</span> <span class="o">=</span> <span class="n">update_firstlineno</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">py_ast</span><span class="o">.</span><span class="n">lineno</span><span class="p">)</span>
    <span class="n">bp_code</span> <span class="o">=</span> <span class="n">Code</span><span class="o">.</span><span class="n">from_code</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
    <span class="n">replace_global_loads</span><span class="p">(</span><span class="n">bp_code</span><span class="o">.</span><span class="n">code</span><span class="p">)</span>
    <span class="n">optimize_locals</span><span class="p">(</span><span class="n">bp_code</span><span class="o">.</span><span class="n">code</span><span class="p">)</span>
    <span class="n">bp_code</span><span class="o">.</span><span class="n">newlocals</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">return</span> <span class="n">bp_code</span><span class="o">.</span><span class="n">to_code</span><span class="p">()</span>

</div>
<div class="viewcode-block" id="compile_notify"><a class="viewcode-back" href="../../../api_ref/enaml.core.html#enaml.core.enaml_compiler.compile_notify">[docs]</a><span class="k">def</span> <span class="nf">compile_notify</span><span class="p">(</span><span class="n">py_ast</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Compile an ast into a code object implementing operator `::`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    py_ast : ast.Module</span>
<span class="sd">        A Python ast Module node.</span>

<span class="sd">    filename : string</span>
<span class="sd">        The filename which generated the expression.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    result : types.CodeType</span>
<span class="sd">        A Python code object which implements the desired behavior.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">explicit_globals</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">ast</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">py_ast</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Global</span><span class="p">):</span>
            <span class="n">explicit_globals</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">names</span><span class="p">)</span>
    <span class="n">code</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="n">py_ast</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&#39;exec&#39;</span><span class="p">)</span>
    <span class="n">bp_code</span> <span class="o">=</span> <span class="n">Code</span><span class="o">.</span><span class="n">from_code</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
    <span class="n">replace_global_loads</span><span class="p">(</span><span class="n">bp_code</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="n">explicit_globals</span><span class="p">)</span>
    <span class="n">optimize_locals</span><span class="p">(</span><span class="n">bp_code</span><span class="o">.</span><span class="n">code</span><span class="p">)</span>
    <span class="n">bp_code</span><span class="o">.</span><span class="n">newlocals</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">return</span> <span class="n">bp_code</span><span class="o">.</span><span class="n">to_code</span><span class="p">()</span>

</div>
<div class="viewcode-block" id="compile_subscribe"><a class="viewcode-back" href="../../../api_ref/enaml.core.html#enaml.core.enaml_compiler.compile_subscribe">[docs]</a><span class="k">def</span> <span class="nf">compile_subscribe</span><span class="p">(</span><span class="n">py_ast</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Compile an ast into a code object implementing operator `&lt;&lt;`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    py_ast : ast.Expression</span>
<span class="sd">        A Python ast Expression node.</span>

<span class="sd">    filename : string</span>
<span class="sd">        The filename which generated the expression.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    result : types.CodeType</span>
<span class="sd">        A Python code object which implements the desired behavior.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">code</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="n">py_ast</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&#39;eval&#39;</span><span class="p">)</span>
    <span class="n">code</span> <span class="o">=</span> <span class="n">update_firstlineno</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">py_ast</span><span class="o">.</span><span class="n">lineno</span><span class="p">)</span>
    <span class="n">bp_code</span> <span class="o">=</span> <span class="n">Code</span><span class="o">.</span><span class="n">from_code</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
    <span class="n">replace_global_loads</span><span class="p">(</span><span class="n">bp_code</span><span class="o">.</span><span class="n">code</span><span class="p">)</span>
    <span class="n">optimize_locals</span><span class="p">(</span><span class="n">bp_code</span><span class="o">.</span><span class="n">code</span><span class="p">)</span>
    <span class="n">bp_code</span><span class="o">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">inject_tracing</span><span class="p">(</span><span class="n">bp_code</span><span class="o">.</span><span class="n">code</span><span class="p">)</span>
    <span class="n">bp_code</span><span class="o">.</span><span class="n">newlocals</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">bp_code</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;_[tracer]&#39;</span><span class="p">,)</span> <span class="o">+</span> <span class="n">bp_code</span><span class="o">.</span><span class="n">args</span>
    <span class="k">return</span> <span class="n">bp_code</span><span class="o">.</span><span class="n">to_code</span><span class="p">()</span>

</div>
<div class="viewcode-block" id="compile_update"><a class="viewcode-back" href="../../../api_ref/enaml.core.html#enaml.core.enaml_compiler.compile_update">[docs]</a><span class="k">def</span> <span class="nf">compile_update</span><span class="p">(</span><span class="n">py_ast</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Compile an ast into a code object implementing operator `&gt;&gt;`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    py_ast : ast.Expression</span>
<span class="sd">        A Python ast Expression node.</span>

<span class="sd">    filename : string</span>
<span class="sd">        The filename which generated the expression.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    result : types.CodeType</span>
<span class="sd">        A Python code object which implements the desired behavior.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">code</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="n">py_ast</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&#39;eval&#39;</span><span class="p">)</span>
    <span class="n">code</span> <span class="o">=</span> <span class="n">update_firstlineno</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">py_ast</span><span class="o">.</span><span class="n">lineno</span><span class="p">)</span>
    <span class="n">bp_code</span> <span class="o">=</span> <span class="n">Code</span><span class="o">.</span><span class="n">from_code</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
    <span class="n">replace_global_loads</span><span class="p">(</span><span class="n">bp_code</span><span class="o">.</span><span class="n">code</span><span class="p">)</span>
    <span class="n">optimize_locals</span><span class="p">(</span><span class="n">bp_code</span><span class="o">.</span><span class="n">code</span><span class="p">)</span>
    <span class="n">bp_code</span><span class="o">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">inject_inversion</span><span class="p">(</span><span class="n">bp_code</span><span class="o">.</span><span class="n">code</span><span class="p">)</span>
    <span class="n">bp_code</span><span class="o">.</span><span class="n">newlocals</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">bp_code</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;_[inverter]&#39;</span><span class="p">,</span> <span class="s">&#39;_[value]&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">bp_code</span><span class="o">.</span><span class="n">args</span>
    <span class="k">return</span> <span class="n">bp_code</span><span class="o">.</span><span class="n">to_code</span><span class="p">()</span>

</div>
<div class="viewcode-block" id="compile_delegate"><a class="viewcode-back" href="../../../api_ref/enaml.core.html#enaml.core.enaml_compiler.compile_delegate">[docs]</a><span class="k">def</span> <span class="nf">compile_delegate</span><span class="p">(</span><span class="n">py_ast</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Compile an ast into a code object implementing operator `:=`.</span>

<span class="sd">    This will generate two code objects: one which is equivalent to</span>
<span class="sd">    operator `&lt;&lt;` and another which is equivalent to `&gt;&gt;`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    py_ast : ast.Expression</span>
<span class="sd">        A Python ast Expression node.</span>

<span class="sd">    filename : string</span>
<span class="sd">        The filename which generated the expression.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    result : tuple</span>
<span class="sd">        A 2-tuple of types.CodeType equivalent to operators `&lt;&lt;` and</span>
<span class="sd">        `&gt;&gt;` respectively.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">code</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="n">py_ast</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&#39;eval&#39;</span><span class="p">)</span>
    <span class="n">code</span> <span class="o">=</span> <span class="n">update_firstlineno</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">py_ast</span><span class="o">.</span><span class="n">lineno</span><span class="p">)</span>
    <span class="n">bp_code</span> <span class="o">=</span> <span class="n">Code</span><span class="o">.</span><span class="n">from_code</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
    <span class="n">bp_code</span><span class="o">.</span><span class="n">newlocals</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">codelist</span> <span class="o">=</span> <span class="n">bp_code</span><span class="o">.</span><span class="n">code</span><span class="p">[:]</span>
    <span class="n">bp_args</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">bp_code</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
    <span class="n">replace_global_loads</span><span class="p">(</span><span class="n">codelist</span><span class="p">)</span>
    <span class="n">optimize_locals</span><span class="p">(</span><span class="n">codelist</span><span class="p">)</span>
    <span class="n">sub_list</span> <span class="o">=</span> <span class="n">inject_tracing</span><span class="p">(</span><span class="n">codelist</span><span class="p">)</span>
    <span class="n">bp_code</span><span class="o">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">sub_list</span>
    <span class="n">bp_code</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;_[tracer]&#39;</span><span class="p">,)</span> <span class="o">+</span> <span class="n">bp_args</span>
    <span class="n">sub_code</span> <span class="o">=</span> <span class="n">bp_code</span><span class="o">.</span><span class="n">to_code</span><span class="p">()</span>
    <span class="n">upd_list</span> <span class="o">=</span> <span class="n">inject_inversion</span><span class="p">(</span><span class="n">codelist</span><span class="p">)</span>
    <span class="n">bp_code</span><span class="o">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">upd_list</span>
    <span class="n">bp_code</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;_[inverter]&#39;</span><span class="p">,</span> <span class="s">&#39;_[value]&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">bp_args</span>
    <span class="n">upd_code</span> <span class="o">=</span> <span class="n">bp_code</span><span class="o">.</span><span class="n">to_code</span><span class="p">()</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">sub_code</span><span class="p">,</span> <span class="n">upd_code</span><span class="p">)</span>

</div>
<span class="n">COMPILE_OP_MAP</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">&#39;=&#39;</span><span class="p">:</span> <span class="n">compile_simple</span><span class="p">,</span>
    <span class="s">&#39;::&#39;</span><span class="p">:</span> <span class="n">compile_notify</span><span class="p">,</span>
    <span class="s">&#39;&lt;&lt;&#39;</span><span class="p">:</span> <span class="n">compile_subscribe</span><span class="p">,</span>
    <span class="s">&#39;&gt;&gt;&#39;</span><span class="p">:</span> <span class="n">compile_update</span><span class="p">,</span>
    <span class="s">&#39;:=&#39;</span><span class="p">:</span> <span class="n">compile_delegate</span><span class="p">,</span>
<span class="p">}</span>


<span class="c">#------------------------------------------------------------------------------</span>
<span class="c"># Node Visitor</span>
<span class="c">#------------------------------------------------------------------------------</span>
<span class="k">class</span> <span class="nc">_NodeVisitor</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; A node visitor class that is used as base class for the various</span>
<span class="sd">    Enaml compilers.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">visit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; The main visitor dispatch method.</span>

<span class="sd">        Unhandled nodes will raise an error.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s">&#39;visit_</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">node</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">method</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">method</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_visit</span>
        <span class="n">method</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visit_nonstrict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; A nonstrict visitor dispatch method.</span>

<span class="sd">        Unhandled nodes will be ignored.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s">&#39;visit_</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">node</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">method</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">method</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">default_visit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; The default visitor method. Raises an error since there</span>
<span class="sd">        should not be any unhandled nodes.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Unhandled Node </span><span class="si">%s</span><span class="s">.&#39;</span> <span class="o">%</span> <span class="n">node</span><span class="p">)</span>


<span class="c">#------------------------------------------------------------------------------</span>
<span class="c"># EnamlDef Compiler</span>
<span class="c">#------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="EnamlDefCompiler"><a class="viewcode-back" href="../../../api_ref/enaml.core.html#enaml.core.enaml_compiler.EnamlDefCompiler">[docs]</a><span class="k">class</span> <span class="nc">EnamlDefCompiler</span><span class="p">(</span><span class="n">_NodeVisitor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; A visitor which compiles an EnamlDef into a marshallable dict.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="EnamlDefCompiler.compile"><a class="viewcode-back" href="../../../api_ref/enaml.core.html#enaml.core.enaml_compiler.EnamlDefCompiler.compile">[docs]</a>    <span class="k">def</span> <span class="nf">compile</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; The main entry point of the EnamlDefCompiler.</span>

<span class="sd">        This compiler compiles the given EnamlDef node into a dictionary</span>
<span class="sd">        which can be used to build out the component tree at run time.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        node : EnamlDef</span>
<span class="sd">            The EnamlDef node to compile.</span>

<span class="sd">        filename : string</span>
<span class="sd">            The string filename to use for the enamldef.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">compiler</span> <span class="o">=</span> <span class="n">cls</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">compiler</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">compiler</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
</div>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stack</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">visit_EnamlDef</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&#39;filename&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span>
            <span class="s">&#39;lineno&#39;</span><span class="p">:</span> <span class="n">node</span><span class="o">.</span><span class="n">lineno</span><span class="p">,</span>
            <span class="s">&#39;typename&#39;</span><span class="p">:</span> <span class="n">node</span><span class="o">.</span><span class="n">typename</span><span class="p">,</span>
            <span class="s">&#39;base&#39;</span><span class="p">:</span> <span class="n">node</span><span class="o">.</span><span class="n">base</span><span class="p">,</span>
            <span class="s">&#39;identifier&#39;</span><span class="p">:</span> <span class="n">node</span><span class="o">.</span><span class="n">identifier</span><span class="p">,</span>
            <span class="s">&#39;docstring&#39;</span><span class="p">:</span> <span class="n">node</span><span class="o">.</span><span class="n">docstring</span><span class="p">,</span>
            <span class="s">&#39;storage_defs&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s">&#39;bindings&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s">&#39;child_defs&#39;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">body</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visit_StorageDef</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="n">storage_def</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&#39;lineno&#39;</span><span class="p">:</span> <span class="n">node</span><span class="o">.</span><span class="n">lineno</span><span class="p">,</span>
            <span class="s">&#39;kind&#39;</span><span class="p">:</span> <span class="n">node</span><span class="o">.</span><span class="n">kind</span><span class="p">,</span>
            <span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="s">&#39;typename&#39;</span><span class="p">:</span> <span class="n">node</span><span class="o">.</span><span class="n">typename</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s">&#39;storage_defs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">storage_def</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">expr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visit_Binding</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visit_Binding</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="n">opexpr</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">expr</span>
        <span class="n">pyast</span> <span class="o">=</span> <span class="n">opexpr</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">ast</span>
        <span class="n">opcompiler</span> <span class="o">=</span> <span class="n">COMPILE_OP_MAP</span><span class="p">[</span><span class="n">opexpr</span><span class="o">.</span><span class="n">operator</span><span class="p">]</span>
        <span class="n">code</span> <span class="o">=</span> <span class="n">opcompiler</span><span class="p">(</span><span class="n">pyast</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">binding</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&#39;lineno&#39;</span><span class="p">:</span> <span class="n">node</span><span class="o">.</span><span class="n">lineno</span><span class="p">,</span>
            <span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="s">&#39;operator&#39;</span><span class="p">:</span> <span class="n">opexpr</span><span class="o">.</span><span class="n">operator</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="n">code</span><span class="p">,</span> <span class="n">auxcode</span> <span class="o">=</span> <span class="n">code</span>
            <span class="n">binding</span><span class="p">[</span><span class="s">&#39;code&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">code</span>
            <span class="n">binding</span><span class="p">[</span><span class="s">&#39;auxcode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">auxcode</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">binding</span><span class="p">[</span><span class="s">&#39;code&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">code</span>
            <span class="n">binding</span><span class="p">[</span><span class="s">&#39;auxcode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s">&#39;bindings&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">binding</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visit_ChildDef</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&#39;lineno&#39;</span><span class="p">:</span> <span class="n">node</span><span class="o">.</span><span class="n">lineno</span><span class="p">,</span>
            <span class="s">&#39;typename&#39;</span><span class="p">:</span> <span class="n">node</span><span class="o">.</span><span class="n">typename</span><span class="p">,</span>
            <span class="s">&#39;identifier&#39;</span><span class="p">:</span> <span class="n">node</span><span class="o">.</span><span class="n">identifier</span><span class="p">,</span>
            <span class="s">&#39;filename&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span>
            <span class="s">&#39;storage_defs&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s">&#39;bindings&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s">&#39;child_defs&#39;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">body</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s">&#39;child_defs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>


<span class="c">#------------------------------------------------------------------------------</span>
<span class="c"># Enaml Compiler</span>
<span class="c">#------------------------------------------------------------------------------</span></div>
<div class="viewcode-block" id="EnamlCompiler"><a class="viewcode-back" href="../../../api_ref/enaml.core.html#enaml.core.enaml_compiler.EnamlCompiler">[docs]</a><span class="k">class</span> <span class="nc">EnamlCompiler</span><span class="p">(</span><span class="n">_NodeVisitor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; A visitor that will compile an enaml module ast node.</span>

<span class="sd">    The entry point is the `compile` classmethod which will compile</span>
<span class="sd">    the ast into an appropriate python code object for a module.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="EnamlCompiler.compile"><a class="viewcode-back" href="../../../api_ref/enaml.core.html#enaml.core.enaml_compiler.EnamlCompiler.compile">[docs]</a>    <span class="k">def</span> <span class="nf">compile</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">module_ast</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; The main entry point of the compiler.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        module_ast : Instance(enaml_ast.Module)</span>
<span class="sd">            The enaml module ast node that should be compiled.</span>

<span class="sd">        filename : string</span>
<span class="sd">            The string filename of the module ast being compiled.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        result : types.CodeType</span>
<span class="sd">            The code object for the compiled module.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># Generate the startup code for the module</span>
        <span class="n">module_ops</span> <span class="o">=</span> <span class="p">[(</span><span class="n">SetLineno</span><span class="p">,</span> <span class="mi">1</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">start</span> <span class="ow">in</span> <span class="n">STARTUP</span><span class="p">:</span>
            <span class="n">start_code</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&#39;exec&#39;</span><span class="p">)</span>
            <span class="n">bp_code</span> <span class="o">=</span> <span class="n">Code</span><span class="o">.</span><span class="n">from_code</span><span class="p">(</span><span class="n">start_code</span><span class="p">)</span>
            <span class="c"># Skip the SetLineo and ReturnValue codes</span>
            <span class="n">module_ops</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">bp_code</span><span class="o">.</span><span class="n">code</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>

        <span class="c"># Add in the code ops for the module</span>
        <span class="n">compiler</span> <span class="o">=</span> <span class="n">cls</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">compiler</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">module_ast</span><span class="p">)</span>
        <span class="n">module_ops</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">compiler</span><span class="o">.</span><span class="n">code_ops</span><span class="p">)</span>

        <span class="c"># Generate the cleanup code for the module</span>
        <span class="k">for</span> <span class="n">end</span> <span class="ow">in</span> <span class="n">CLEANUP</span><span class="p">:</span>
            <span class="n">end_code</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="n">end</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&#39;exec&#39;</span><span class="p">)</span>
            <span class="n">bp_code</span> <span class="o">=</span> <span class="n">Code</span><span class="o">.</span><span class="n">from_code</span><span class="p">(</span><span class="n">end_code</span><span class="p">)</span>
            <span class="c"># Skip the SetLineo and ReturnValue codes</span>
            <span class="n">module_ops</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">bp_code</span><span class="o">.</span><span class="n">code</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>

        <span class="c"># Add in the final return value ops</span>
        <span class="n">module_ops</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
            <span class="p">(</span><span class="n">LOAD_CONST</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
            <span class="p">(</span><span class="n">RETURN_VALUE</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
        <span class="p">])</span>

        <span class="c"># Generate and return the module code object.</span>
        <span class="n">mod_code</span> <span class="o">=</span> <span class="n">Code</span><span class="p">(</span>
            <span class="n">module_ops</span><span class="p">,</span> <span class="p">[],</span> <span class="p">[],</span> <span class="bp">False</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">,</span>  <span class="n">filename</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">mod_code</span><span class="o">.</span><span class="n">to_code</span><span class="p">()</span>
</div>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">code_ops</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">visit_Module</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">body</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visit_Python</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="n">py_code</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">ast</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&#39;exec&#39;</span><span class="p">)</span>
        <span class="n">bp_code</span> <span class="o">=</span> <span class="n">Code</span><span class="o">.</span><span class="n">from_code</span><span class="p">(</span><span class="n">py_code</span><span class="p">)</span>
        <span class="c"># Skip the SetLineo and ReturnValue codes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">code_ops</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">bp_code</span><span class="o">.</span><span class="n">code</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">visit_EnamlDef</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="n">code_ops</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">code_ops</span>
        <span class="n">dct</span> <span class="o">=</span> <span class="n">EnamlDefCompiler</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">decorator</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">decorators</span><span class="p">:</span>
            <span class="n">code</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="n">decorator</span><span class="o">.</span><span class="n">ast</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&#39;eval&#39;</span><span class="p">)</span>
            <span class="n">bpcode</span> <span class="o">=</span> <span class="n">Code</span><span class="o">.</span><span class="n">from_code</span><span class="p">(</span><span class="n">code</span><span class="p">)</span><span class="o">.</span><span class="n">code</span>
            <span class="n">code_ops</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">bpcode</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>  <span class="c"># skip the return value op</span>
        <span class="n">code_ops</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
            <span class="p">(</span><span class="n">SetLineno</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">lineno</span><span class="p">),</span>
            <span class="p">(</span><span class="n">LOAD_NAME</span><span class="p">,</span> <span class="s">&#39;__make_enamldef_helper&#39;</span><span class="p">),</span>  <span class="c"># Foo = __make_enamldef_helper(dct, globals)</span>
            <span class="p">(</span><span class="n">LOAD_CONST</span><span class="p">,</span> <span class="n">dct</span><span class="p">),</span>                      <span class="c"># dct is a marshalable description dict</span>
            <span class="p">(</span><span class="n">LOAD_NAME</span><span class="p">,</span> <span class="s">&#39;globals&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="n">CALL_FUNCTION</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">),</span>
            <span class="p">(</span><span class="n">CALL_FUNCTION</span><span class="p">,</span> <span class="mh">0x0002</span><span class="p">),</span>
        <span class="p">])</span>
        <span class="k">for</span> <span class="n">dec</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">decorators</span><span class="p">:</span>
            <span class="n">code_ops</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">CALL_FUNCTION</span><span class="p">,</span> <span class="mh">0x0001</span><span class="p">))</span>
        <span class="n">code_ops</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">STORE_NAME</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">typename</span><span class="p">))</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">enaml v0.7.6</a> &raquo;</li>
          <li><a href="../../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2013, Nucleic Development Team.
      <br>
      Last updated on May 07, 2013.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.2.
    </div>
  </body>
</html>